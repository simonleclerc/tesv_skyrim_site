<!DOCTYPE html>
<html>
<head>
    <title>Poolboy - map</title>
    <link href="css/reset.css" media="all" rel="stylesheet"/>
    <link href="css/style.css" media="all" rel="stylesheet"/>
    <style>
        html, body, #map-canvas {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
    </style>
</head>
<body style="background-color: #000000;">

<div id="map-canvas"></div>

<script type="text/javascript" src="js/greensock-js/src/minified/TweenMax.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
<script src="js/markerWithLabel.js"></script>
<script>
    /*@TODO
    * change color map (blue/white/grey theme if possible
     * add button to : center on location, center on destination (Aix-en-Provence), display/hide travel direction
     * add all city
     * create icon for minor city (mills, tower, anchor etc)
     * place all minors icons
     * max/min zoom level
     * on travel direction display, stop zoom
     * back button
     * add footer with button + localisation
     * add origin + destination markers
     * add window info on cities related to me
     * add modal on localisation failed/denied with a city to choose
    *
    *
    */
    var geocoder;
    var map;
    var infowindow = new google.maps.InfoWindow();
    var marker;
    var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
    var directionsService = new google.maps.DirectionsService;

var mapStyles = [
    {
        "elementType": "labels.icon",
        "stylers": [
            { "visibility": "off" }
        ]
    },{
        "featureType": "landscape.natural",
        "stylers": [
            { "hue": "#0008ff" },
            { "saturation": -43 },
            { "gamma": 0.97 },
            { "lightness": -4 }
        ]
    },{
        "featureType": "water",
        "stylers": [
            { "saturation": -100 },
            { "lightness": -51 },
            { "gamma": 1.2 }
        ]
    },{
        "featureType": "transit",
        "stylers": [
            { "visibility": "off" }
        ]
    },{
        "featureType": "poi",
        "stylers": [
            { "saturation": -79 },
            { "hue": "#0022ff" },
            { "lightness": -17 }
        ]
    },{
        "featureType": "road.highway",
        "stylers": [
            { "lightness": 100 },
            { "weight": 0.3 }
        ]
    },{
        "featureType": "road.arterial",
        "stylers": [
            { "visibility": "on" },
            { "hue": "#ff0011" },
            { "saturation": -100 },
            { "lightness": 29 },
            { "weight": 0.2 }
        ]
    },{
        "featureType": "road.local",
        "stylers": [
            { "visibility": "off" }
        ]
    },{
        "featureType": "administrative",
        "elementType": "geometry.stroke",
        "stylers": [
            { "visibility": "off" }
        ]
    },{
        "elementType": "labels.text.fill",
        "stylers": [
            { "hue": "#00ccff" },
            { "saturation": 100 },
            { "lightness": 100 }
        ]
    },{
        "featureType": "all",
        "elementType": "labels.text.stroke",
        "stylers": [
            { "hue": "#00ff99" },
            { "saturation": -100 },
            { "lightness": -100 }
        ]
    },{
    }
];




    function maPosition(pos){
        var latlng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        geocoder.geocode({'latLng': latlng}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                var mapOptions = {
                    zoom: 8,
                    center: latlng,
                    mapTypeId: 'roadmap'
                }
                map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
                map.setOptions({styles: mapStyles});

                var currentLocationMarkerIcon = {
                    path: 'M 501.519,363.412 507.663,363.412 510.168,360.017 504.914,358.885 508.794,353.873 516.716,357.106 512,363.412 516.716,363.412 509.953,404.802 z',
                    fillColor: 'yellow',
                    fillOpacity: 0.8,
                    scale: 5,
                    strokeColor: 'gold',
                    strokeWeight: 1
                };

                var marker = new google.maps.Marker({
                    position: latlng,
                    map: map,
                    title: 'Hello World!'
                });
                var parisMarker = new MarkerWithLabel({
                    position: new google.maps.LatLng(48.8566140,2.3522219),
                    map: map,
                    labelContent: "Paris",
                    labelAnchor: new google.maps.Point(42, -46),
                    labelClass: "marker-label", // the CSS class for the label
                    icon: {
                        scaledSize: new google.maps.Size(50, 79),
                        url: 'images/map/ico_Paris.png',
                        anchor: new google.maps.Point(25, 40)
                    }
                });

                directionsDisplay.setMap(map);
                calculateAndDisplayRoute(directionsService, directionsDisplay, {lat: pos.coords.latitude, lnt: pos.coords.longitude},
//                        {lat: 43.529742, lnt: 5.447427} //Aix-en-Provence
                        {lat: 48.8566140, lnt: 2.3522219} //Paris

                );

                google.maps.event.addDomListener(parisMarker, 'mouseover', function(e) {
                    parisMarker.set('labelClass', 'marker-label--active');
                    TweenMax.to('.marker-label--active',.3, {x: 80, y: -60, opacity: 1, fontSize: '35px'});
                });
                google.maps.event.addDomListener(parisMarker, 'mouseout', function(e) {
                    TweenMax.to('.marker-label--active',.3, {x: 0, y: 0, opacity: 0, fontSize: '0px', onComplete: function(){
                        parisMarker.set('labelClass', 'marker-label');
                    }});
                });
//                if(results[1]) {
//                    var location = document.getElementById('gmap-city');
//                    location.innerHTML = results[1].formatted_address;
//                }
            } else {
                alert('Geocoder failed due to: ' + status);
            }
        });
    }
    function calculateAndDisplayRoute(directionsService, directionsDisplay, origin, destination) {
        directionsService.route({
            origin: {lat: origin.lat, lng: origin.lnt},
            destination: {lat: destination.lat, lng: destination.lnt},
            travelMode: google.maps.TravelMode['DRIVING']
        }, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            } else {
                console.log('Directions request failed due to ' + status);
            }
        });
    }
    function erreurPosition(error) {
        var info = "Erreur lors de la géolocalisation : ";
        switch(error.code) {
            case error.TIMEOUT:
                info += "Timeout !";
                break;
            case error.PERMISSION_DENIED:
                info += "Vous n’avez pas donné la permission";
                break;
            case error.POSITION_UNAVAILABLE:
                info += "La position n’a pu être déterminée";
                break;
            case error.UNKNOWN_ERROR:
                info += "Erreur inconnue";
                break;
        }
        console.log(info);
    }

    function initialize() {
        geocoder = new google.maps.Geocoder();
        if(navigator.geolocation) {
            survId = navigator.geolocation.getCurrentPosition(maPosition,erreurPosition);
        } else {
            alert("Ce navigateur ne supporte pas la géolocalisation");
        }
    }

    function codeLatLng() {
        var input = document.getElementById('latlng').value;
        var latlngStr = input.split(',', 2);
        var lat = parseFloat(latlngStr[0]);
        var lng = parseFloat(latlngStr[1]);
        var latlng = new google.maps.LatLng(lat, lng);
        geocoder.geocode({'latLng': latlng}, function(results, status) {
            console.log(results)
            if (status == google.maps.GeocoderStatus.OK) {
                if (results[1]) {
                    map.setZoom(11);
                    marker = new google.maps.Marker({
                        position: latlng,
                        map: map
                    });
                    infowindow.setContent(results[1].formatted_address);
                    infowindow.open(map, marker);
                } else {
                    alert('No results found');
                }
            } else {
                alert('Geocoder failed due to: ' + status);
            }
        });
    }

    google.maps.event.addDomListener(window, 'load', initialize);

</script>
</body>
</html>
